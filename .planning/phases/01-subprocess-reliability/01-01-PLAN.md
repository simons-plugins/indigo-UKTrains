---
phase: 01-subprocess-reliability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py
  - UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py
  - UKTrains.indigoPlugin/Contents/Server Plugin/Devices.xml
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Subprocess execution never hangs indefinitely (10-second timeout enforced)"
    - "Device state updates when subprocess times out or fails"
    - "Subprocess stderr appears in plugin logs for debugging"
    - "Color definitions from constants.py correctly passed to text2png.py"
  artifacts:
    - path: "UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py"
      provides: "Timeout-enforced subprocess execution with error handling"
      contains: "timeout=10"
    - path: "UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py"
      provides: "Device state update on subprocess failure"
      contains: "imageGenerationStatus"
    - path: "UKTrains.indigoPlugin/Contents/Server Plugin/Devices.xml"
      provides: "Device state definition for image generation status"
      contains: "imageGenerationStatus"
  key_links:
    - from: "image_generator.py:_generate_departure_image"
      to: "plugin.py:routeUpdate"
      via: "function call with device parameter"
      pattern: "_generate_departure_image.*device"
    - from: "image_generator.py"
      to: "subprocess.run"
      via: "timeout parameter"
      pattern: "subprocess\\.run.*timeout"
---

<objective>
Add timeout enforcement, exception handling, and stderr capture to the subprocess image generation to prevent indefinite hangs and enable debugging.

Purpose: The current subprocess execution has no timeout, no exception handling for failures, and writes stderr to separate files that are never checked. This phase adds production-ready subprocess management so image generation failures are visible and recoverable.

Output: Modified image_generator.py with timeout and error handling, updated plugin.py to handle failures, and new device state for tracking image generation status.
</objective>

<execution_context>
@/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-subprocess-reliability/01-RESEARCH.md
@UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py
@UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py
@UKTrains.indigoPlugin/Contents/Server Plugin/constants.py
@UKTrains.indigoPlugin/Contents/Server Plugin/Devices.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timeout and error handling to subprocess execution</name>
  <files>UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py</files>
  <action>
Modify `_generate_departure_image()` function to:

1. **Add timeout parameter** to subprocess.run():
   - Set timeout=10 (10 seconds - generous for I/O-bound image generation)

2. **Replace file-based output capture with capture_output=True**:
   - Remove the `with open(output_log) as output_file` pattern
   - Use capture_output=True and text=True parameters instead
   - Delete the separate log file writing

3. **Add comprehensive exception handling**:
   - Wrap subprocess.run() in try/except
   - Catch subprocess.TimeoutExpired - log timeout with device context
   - Catch subprocess.CalledProcessError - log exit code and stderr
   - Catch FileNotFoundError - log if Python interpreter not found
   - Catch generic Exception as fallback

4. **Add device and logger parameters to function signature**:
   - Add `device` parameter (Indigo device object)
   - Add `logger` parameter (PluginLogger instance)
   - These are needed to update device state and log errors

5. **Return boolean success/failure**:
   - Return True on successful image generation
   - Return False on any exception
   - Update device state imageGenerationStatus accordingly

6. **Log subprocess output to plugin logger**:
   - On success: log stdout/stderr at debug level
   - On failure: log stderr at error level

Reference the research document's "Complete UK-Trains Subprocess Pattern" for the implementation pattern.

DO NOT change the subprocess arguments (cmd list) - the color parameters are passed correctly via the parameters file.
  </action>
  <verify>
Run `python3 -m py_compile UKTrains.indigoPlugin/Contents/Server\ Plugin/image_generator.py` - should exit with code 0 (no syntax errors).
  </verify>
  <done>
_generate_departure_image() has: timeout=10 parameter, capture_output=True, try/except for TimeoutExpired and CalledProcessError, device and logger parameters, returns boolean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add device state for image generation status</name>
  <files>UKTrains.indigoPlugin/Contents/Server Plugin/Devices.xml</files>
  <action>
Add a new device state to track image generation status.

1. **Add imageGenerationStatus state** to the trainTimetable device type:
   - Type: String
   - Default: "pending"
   - Valid values: "success", "timeout", "failed", "config_error", "error", "pending"

2. **Location in Devices.xml**:
   - Find the `<States>` section within trainTimetable device
   - Add after the existing states (like stationIssues, deviceActive, etc.)

State definition format:
```xml
<State id="imageGenerationStatus">
    <ValueType>String</ValueType>
    <TriggerLabel>Image Generation Status</TriggerLabel>
    <ControlPageLabel>Image Status</ControlPageLabel>
</State>
```
  </action>
  <verify>
Validate XML syntax: `xmllint --noout UKTrains.indigoPlugin/Contents/Server\ Plugin/Devices.xml` should exit with code 0.
  </verify>
  <done>
Devices.xml contains imageGenerationStatus state definition within trainTimetable device.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update routeUpdate to pass device and logger and handle failures</name>
  <files>UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py</files>
  <action>
Modify the routeUpdate() function and its caller to handle image generation failures.

1. **Update routeUpdate() function signature**:
   - Add `logger` parameter to receive the PluginLogger instance
   - The `dev` parameter already exists

2. **Update _generate_departure_image() call** (around line 380):
   - Pass `dev` (device object) as the device parameter
   - Pass `logger` as the logger parameter
   - Capture the boolean return value

3. **Handle image generation failure**:
   - If _generate_departure_image() returns False:
     - Log at error level that image generation failed
     - Device state is already updated by _generate_departure_image()
   - If returns True:
     - Optionally log success at debug level

4. **Update caller in runConcurrentThread()** (around line 804):
   - The call to routeUpdate() needs to pass self.plugin_logger
   - Change: `deviceRefresh = routeUpdate(dev, runtime_config.api_key, runtime_config.darwin_url, self.paths)`
   - To: `deviceRefresh = routeUpdate(dev, runtime_config.api_key, runtime_config.darwin_url, self.paths, self.plugin_logger)`

5. **Verify color parameter passing (BUG-01)**:
   - Check that runConcurrentThread() writes parameters file (line 769-770)
   - Colors are read from runtime_config.color_scheme
   - Format: `f'{colors.foreground},{colors.background},{colors.issue},{colors.title},{colors.calling_points},9,3,3,720'`
   - This is correct - colors from constants.py/plugin prefs flow through ColorScheme to parameters file

DO NOT remove the indigo.debugger() call - that's for development debugging.
  </action>
  <verify>
Run `python3 -m py_compile UKTrains.indigoPlugin/Contents/Server\ Plugin/plugin.py` - should exit with code 0 (no syntax errors).
  </verify>
  <done>
routeUpdate() accepts logger parameter, passes device and logger to _generate_departure_image(), handles boolean return. runConcurrentThread() passes self.plugin_logger to routeUpdate(). Color parameters correctly passed via parameters file (BUG-01 verified).
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Syntax check all modified files**:
   ```bash
   python3 -m py_compile UKTrains.indigoPlugin/Contents/Server\ Plugin/image_generator.py
   python3 -m py_compile UKTrains.indigoPlugin/Contents/Server\ Plugin/plugin.py
   xmllint --noout UKTrains.indigoPlugin/Contents/Server\ Plugin/Devices.xml
   ```

2. **Code inspection**:
   - grep for `timeout=10` in image_generator.py
   - grep for `capture_output=True` in image_generator.py
   - grep for `TimeoutExpired` in image_generator.py
   - grep for `imageGenerationStatus` in Devices.xml
   - grep for `imageGenerationStatus` in image_generator.py

3. **Requirement verification**:
   - SUB-01: `timeout=10` present in subprocess.run() call
   - SUB-02: `except subprocess.TimeoutExpired` block exists
   - SUB-03: `device.updateStateOnServer('imageGenerationStatus'` called in exception handlers
   - SUB-04: `logger.error(f"stderr: {` present in exception handlers
   - SUB-05: Uses `subprocess.run()` (not call())
   - BUG-01: Color parameters written to file in runConcurrentThread(), read by text2png.py
</verification>

<success_criteria>
- subprocess.run() call in image_generator.py has timeout=10 parameter
- capture_output=True replaces file-based output capture
- try/except blocks catch TimeoutExpired, CalledProcessError, FileNotFoundError
- Device state imageGenerationStatus updated on success/failure
- Devices.xml defines imageGenerationStatus state
- All Python files pass syntax check
- Devices.xml passes XML validation
</success_criteria>

<output>
After completion, create `.planning/phases/01-subprocess-reliability/01-01-SUMMARY.md`
</output>
