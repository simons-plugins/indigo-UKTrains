---
phase: 02-change-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py
  - UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py
  - UKTrains.indigoPlugin/Contents/Server Plugin/Devices.xml
autonomous: true

must_haves:
  truths:
    - "Image regeneration is skipped when departure board data is unchanged"
    - "Image regeneration occurs when departure board data changes"
    - "Image regeneration occurs when color scheme changes"
    - "First poll for a device always generates an image"
    - "Hash is updated only after successful image generation"
  artifacts:
    - path: "UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py"
      provides: "compute_board_content_hash function"
      contains: "hashlib.sha256"
    - path: "UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py"
      provides: "Hash comparison logic in routeUpdate"
      contains: "image_content_hash"
    - path: "UKTrains.indigoPlugin/Contents/Server Plugin/Devices.xml"
      provides: "image_content_hash device state definition"
      contains: "image_content_hash"
  key_links:
    - from: "plugin.py"
      to: "image_generator.py"
      via: "compute_board_content_hash import"
      pattern: "from image_generator import.*compute_board_content_hash"
    - from: "plugin.py"
      to: "device.states"
      via: "hash storage and retrieval"
      pattern: "dev\\.states\\.get\\('image_content_hash'"
    - from: "compute_board_content_hash"
      to: "parameters file"
      via: "reads colors from trainparameters.txt"
      pattern: "parameters_file_path.*open"
---

<objective>
Add content-based change detection to skip unnecessary PNG regenerations when departure board data is unchanged.

Purpose: Currently the plugin regenerates departure board images on every Darwin API poll (every 60 seconds by default) even when the departure data is identical. This wastes CPU/disk I/O and obscures when actual data changes occur. Content hashing will detect when visual output would change and skip generation when unchanged.

Output: SHA-256 hash computation function in image_generator.py, hash comparison logic in routeUpdate(), and image_content_hash device state in Devices.xml.
</objective>

<execution_context>
@/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-change-detection/02-RESEARCH.md
@.planning/phases/01-subprocess-reliability/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add hash computation function and device state</name>
  <files>
    - UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py
    - UKTrains.indigoPlugin/Contents/Server Plugin/Devices.xml
  </files>
  <action>
Add SHA-256 content hash computation to image_generator.py:

1. Add `import hashlib` at the top of image_generator.py (after existing imports)

2. Add the following function after the `errorHandler` function (around line 21):

```python
def compute_board_content_hash(
    board_text_path: Path,
    parameters_file_path: Path
) -> str:
    """Compute SHA-256 hash of departure board content and rendering parameters.

    Includes all inputs that affect visual output: board text and color scheme.
    Any change to either component produces a different hash.

    Args:
        board_text_path: Path to departure board text file
        parameters_file_path: Path to trainparameters.txt containing color config

    Returns:
        Lowercase hex-encoded SHA-256 hash (64 characters)
    """
    hasher = hashlib.sha256()

    # Hash departure board text content
    with open(board_text_path, 'r', encoding='utf-8') as f:
        board_content = f.read()
    hasher.update(board_content.encode('utf-8'))

    # Hash color parameters from parameters file
    # File format: 'fg,bg,issue,title,calling_points,9,3,3,720'
    # We hash the first 5 comma-separated values (the colors)
    with open(parameters_file_path, 'r', encoding='utf-8') as f:
        params_content = f.read().strip()
    color_values = ','.join(params_content.split(',')[:5])
    hasher.update(color_values.encode('utf-8'))

    return hasher.hexdigest()
```

3. Add `image_content_hash` device state to Devices.xml. Insert after the `imageGenerationStatus` state block (around line 116). Use the EXACT indentation pattern from existing states (tabs):

```xml
		<State id="image_content_hash"
			   readonly="YES">
			<ValueType>String</ValueType>
			<TriggerLabel>Image Content Hash</TriggerLabel>
			<ControlPageLabel>Content Hash</ControlPageLabel>
		</State>
```

Important: Match the indentation exactly - use tabs, not spaces. The State id attribute should start with two tabs.
  </action>
  <verify>
```bash
# Verify Python syntax
python3 -m py_compile "UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py"
echo "Exit code: $?"

# Verify XML validity
xmllint --noout "UKTrains.indigoPlugin/Contents/Server Plugin/Devices.xml"
echo "Exit code: $?"

# Verify hash function exists
grep -n "def compute_board_content_hash" "UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py"

# Verify hashlib import
grep -n "import hashlib" "UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py"

# Verify device state added
grep -n "image_content_hash" "UKTrains.indigoPlugin/Contents/Server Plugin/Devices.xml"

# Verify function signature uses parameters_file_path (not color_scheme)
grep -n "parameters_file_path: Path" "UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py"
```
  </verify>
  <done>
    - hashlib.sha256 used for hash computation (CHG-05)
    - compute_board_content_hash function reads text file and parameters file
    - Function parses first 5 comma-separated color values from parameters file
    - image_content_hash state defined in Devices.xml (CHG-02)
    - All files pass syntax validation
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate hash comparison into routeUpdate</name>
  <files>
    - UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py
  </files>
  <action>
Modify plugin.py to add change detection before image generation:

1. Update the import from image_generator (around line 251) to include the new function:
```python
from image_generator import (
    _write_departure_board_text,
    _generate_departure_image,
    _append_train_to_image,
    _format_station_board,
    compute_board_content_hash,
)
```

2. In the routeUpdate function, REPLACE the existing image generation code block (lines 378-394) with hash-based change detection:

Find this block (starting around line 378):
```python
	# Generate PNG image from text file
	indigo.debugger()
	parameters_file = paths.get_parameters_file()
	image_success = _generate_departure_image(
		paths.plugin_root,
		image_filename,
		train_text_file,
		parameters_file,
		departures_available=departures_found,
		device=dev,
		logger=logger
	)

	if not image_success:
		logger.error(f"Image generation failed for device '{dev.name}'")
	else:
		logger.debug(f"Image generation succeeded for device '{dev.name}'")
```

Replace with:
```python
	# Check if image regeneration needed using content hash
	parameters_file = paths.get_parameters_file()
	current_hash = compute_board_content_hash(train_text_file, parameters_file)
	previous_hash = dev.states.get('image_content_hash', '')

	# Log hash comparison for debugging
	if logger:
		if previous_hash:
			logger.debug(f"Content hash for '{dev.name}': prev={previous_hash[:16]}... curr={current_hash[:16]}...")
		else:
			logger.debug(f"No previous hash for '{dev.name}' (first generation)")

	if current_hash != previous_hash:
		# Content changed - regenerate image
		logger.info(f"Board content changed for '{dev.name}', regenerating image")

		image_success = _generate_departure_image(
			paths.plugin_root,
			image_filename,
			train_text_file,
			parameters_file,
			departures_available=departures_found,
			device=dev,
			logger=logger
		)

		if image_success:
			# Update hash only after successful generation
			dev.updateStateOnServer('image_content_hash', current_hash)
			logger.debug(f"Updated content hash for '{dev.name}'")
		else:
			logger.error(f"Image generation failed for '{dev.name}', will retry next cycle")
	else:
		# Content unchanged - skip generation
		logger.debug(f"Board content unchanged for '{dev.name}', skipping image generation")
```

Important notes:
- Use `paths.get_parameters_file()` which is already available via the `paths` parameter in routeUpdate
- The routeUpdate signature is `def routeUpdate(dev, apiAccess, networkrailURL, paths, logger):`
- No signature changes needed - `paths` already provides access to parameters file
- The hash comparison happens AFTER writing the text file, so we hash the newly written content
- Remove the `indigo.debugger()` call that was there (it was likely for debugging)
- Only update device state hash AFTER successful image generation (CHG-04)
  </action>
  <verify>
```bash
# Verify Python syntax
python3 -m py_compile "UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py"
echo "Exit code: $?"

# Verify import added
grep -n "compute_board_content_hash" "UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py"

# Verify hash comparison logic
grep -n "image_content_hash" "UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py"

# Verify conditional generation
grep -n "current_hash != previous_hash" "UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py"

# Verify hash update after success
grep -n "updateStateOnServer.*image_content_hash" "UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py"

# Verify parameters_file used (not runtime_config.color_scheme)
grep -n "compute_board_content_hash.*parameters_file" "UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py"
```
  </verify>
  <done>
    - compute_board_content_hash imported from image_generator
    - Content hash computed from board text and parameters file (CHG-01)
    - Hash compared with previous value from device state (CHG-03)
    - Image generation skipped when hash unchanged (CHG-03)
    - Hash updated in device state after successful generation (CHG-04)
    - PNG generation executes when Darwin API data updates (BUG-02)
    - All files pass syntax validation
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify:

1. **Syntax validation:**
```bash
python3 -m py_compile "UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py"
python3 -m py_compile "UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py"
xmllint --noout "UKTrains.indigoPlugin/Contents/Server Plugin/Devices.xml"
```

2. **Requirement coverage:**
```bash
# CHG-01: Hash computed from board text and colors
grep -q "compute_board_content_hash" "UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py" && echo "CHG-01: PASS"

# CHG-02: Hash stored in device state
grep -q "image_content_hash" "UKTrains.indigoPlugin/Contents/Server Plugin/Devices.xml" && echo "CHG-02: PASS"

# CHG-03: Regeneration skipped if unchanged
grep -q "current_hash != previous_hash" "UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py" && echo "CHG-03: PASS"

# CHG-04: Hash updated after successful generation
grep -q "updateStateOnServer.*image_content_hash.*current_hash" "UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py" && echo "CHG-04: PASS"

# CHG-05: SHA256 algorithm used
grep -q "hashlib.sha256" "UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py" && echo "CHG-05: PASS"

# BUG-02: Generation executes when data updates
grep -q "Board content changed.*regenerating" "UKTrains.indigoPlugin/Contents/Server Plugin/plugin.py" && echo "BUG-02: PASS"
```
</verification>

<success_criteria>
- [ ] hashlib.sha256 used for hash computation
- [ ] compute_board_content_hash function exists in image_generator.py
- [ ] Function reads text file content and parameters file (not ColorScheme object)
- [ ] Function parses colors from parameters file format (first 5 CSV values)
- [ ] image_content_hash device state defined in Devices.xml
- [ ] Import updated in plugin.py to include compute_board_content_hash
- [ ] Hash comparison logic uses paths.get_parameters_file() (not runtime_config)
- [ ] Hash comparison logic prevents unnecessary regeneration
- [ ] Hash updated in device state only after successful generation
- [ ] All Python files pass syntax check
- [ ] Devices.xml passes XML validation
</success_criteria>

<output>
After completion, create `.planning/phases/02-change-detection/02-01-SUMMARY.md`
</output>
