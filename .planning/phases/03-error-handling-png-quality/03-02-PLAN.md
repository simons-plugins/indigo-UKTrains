---
phase: 03-error-handling-png-quality
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py
  - UKTrains.indigoPlugin/Contents/Server Plugin/Devices.xml
autonomous: true

must_haves:
  truths:
    - "Parent process distinguishes between exit codes 0/1/2/3 from text2png.py"
    - "Device state displays specific error message when image generation fails"
    - "User can see imageGenerationError state in Indigo device"
    - "PNG images display correctly in Indigo control pages"
    - "PNG format compatible with Pushover notification delivery"
    - "Each route device generates its own PNG file"
  artifacts:
    - path: "UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py"
      provides: "Exit code handling and device state updates"
      contains: "returncode == 0"
      contains: "returncode == 1"
      contains: "returncode == 2"
      contains: "imageGenerationError"
    - path: "UKTrains.indigoPlugin/Contents/Server Plugin/Devices.xml"
      provides: "Device state schema with error field"
      contains: "imageGenerationError"
  key_links:
    - from: "image_generator.py"
      to: "text2png.py exit codes"
      via: "subprocess returncode handling"
      pattern: "result\\.returncode"
    - from: "image_generator.py"
      to: "device state"
      via: "updateStateOnServer"
      pattern: "imageGenerationError.*updateStateOnServer"
---

<objective>
Implement exit code handling in parent process and add device error state

Purpose: Enable meaningful error reporting to users via Indigo device states. Users see specific error messages ("File I/O error", "PIL error") instead of generic "failed" status. Enables Indigo triggers based on error types.

Output: Updated image_generator.py with exit code handling, Devices.xml with imageGenerationError state
</objective>

<execution_context>
@/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-error-handling-png-quality/03-RESEARCH.md
@.planning/phases/03-error-handling-png-quality/03-01-SUMMARY.md
@UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py
@UKTrains.indigoPlugin/Contents/Server Plugin/Devices.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add imageGenerationError device state</name>
  <files>UKTrains.indigoPlugin/Contents/Server Plugin/Devices.xml</files>
  <action>
Add new device state for error messages in Devices.xml.

1. Find the existing `imageGenerationStatus` state (around line 111-116)

2. Add new state immediately after it (before `image_content_hash`):
   ```xml
   <State id="imageGenerationError"
          readonly="YES">
       <ValueType>String</ValueType>
       <TriggerLabel>Image Generation Error</TriggerLabel>
       <ControlPageLabel>Image Error</ControlPageLabel>
   </State>
   ```

This state will store human-readable error messages like:
- "" (empty string on success)
- "File I/O error: cannot read input files"
- "PIL error: font loading failed"
- "Timeout after 10 seconds"
- "Configuration error"

The existing imageGenerationStatus remains for status codes (success/failed/timeout/error).
  </action>
  <verify>
Read Devices.xml and confirm:
- imageGenerationError state exists
- State has ValueType=String
- State has TriggerLabel and ControlPageLabel
- State is positioned near imageGenerationStatus
  </verify>
  <done>Device schema includes imageGenerationError state for user-visible error messages, enabling Indigo triggers and control page display.</done>
</task>

<task type="auto">
  <name>Task 2: Implement exit code handling in image_generator.py</name>
  <files>UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py</files>
  <action>
Refactor _generate_departure_image() to handle specific exit codes from text2png.py.

1. Change from `check=True` to `check=False` in subprocess.run() call (around line 127):
   - We want to handle exit codes manually, not raise CalledProcessError

2. Replace the existing exception handling with exit code-based handling:

```python
def _generate_departure_image(
    plugin_root: Path,
    image_filename: Path,
    text_filename: Path,
    parameters_filename: Path,
    departures_available: bool,
    device,
    logger
) -> bool:
    """Launch subprocess to generate PNG image from text file.

    Handles text2png.py exit codes:
        0 = Success
        1 = File I/O error (read/write failures)
        2 = PIL/Pillow error (font loading, image creation)
        3 = Other error (arguments, configuration)

    Args:
        plugin_root: Path to plugin root directory
        image_filename: Path where PNG will be saved
        text_filename: Path to input text file
        parameters_filename: Path to parameters configuration file
        departures_available: Boolean indicating if departures exist
        device: Indigo device object for state updates
        logger: Plugin logger for error reporting

    Returns:
        True if image generated successfully, False otherwise
    """
    dep_flag = 'YES' if departures_available else 'NO'

    cmd = [
        constants.PYTHON3_PATH,
        str(plugin_root / 'text2png.py'),
        str(image_filename),
        str(text_filename),
        str(parameters_filename),
        dep_flag
    ]

    try:
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=10,
            check=False  # Handle exit codes manually
        )

        # Log subprocess output for debugging
        if result.stdout:
            logger.debug(f"Image generation stdout: {result.stdout}")
        if result.stderr:
            logger.debug(f"Image generation stderr: {result.stderr}")

        # Handle exit codes
        if result.returncode == 0:
            # Success
            logger.debug(f"Image generated successfully for '{device.name}'")
            device.updateStateOnServer('imageGenerationStatus', 'success')
            device.updateStateOnServer('imageGenerationError', '')
            return True

        elif result.returncode == 1:
            # File I/O error
            error_msg = "File I/O error: cannot read input files or write PNG"
            logger.error(f"{error_msg} for device '{device.name}'")
            if result.stderr:
                logger.error(f"Details: {result.stderr}")
            device.updateStateOnServer('imageGenerationStatus', 'failed')
            device.updateStateOnServer('imageGenerationError', error_msg)
            return False

        elif result.returncode == 2:
            # PIL/Pillow error
            error_msg = "PIL error: font loading or image creation failed"
            logger.error(f"{error_msg} for device '{device.name}'")
            if result.stderr:
                logger.error(f"Details: {result.stderr}")
            device.updateStateOnServer('imageGenerationStatus', 'failed')
            device.updateStateOnServer('imageGenerationError', error_msg)
            return False

        elif result.returncode == 3:
            # Other error (arguments, configuration)
            error_msg = "Configuration error in image generation"
            logger.error(f"{error_msg} for device '{device.name}'")
            if result.stderr:
                logger.error(f"Details: {result.stderr}")
            device.updateStateOnServer('imageGenerationStatus', 'failed')
            device.updateStateOnServer('imageGenerationError', error_msg)
            return False

        else:
            # Unknown exit code
            error_msg = f"Unknown error (exit code {result.returncode})"
            logger.error(f"{error_msg} for device '{device.name}'")
            if result.stderr:
                logger.error(f"Details: {result.stderr}")
            device.updateStateOnServer('imageGenerationStatus', 'failed')
            device.updateStateOnServer('imageGenerationError', error_msg)
            return False

    except subprocess.TimeoutExpired as e:
        error_msg = "Timeout after 10 seconds"
        logger.error(f"Image generation timed out for device '{device.name}'")
        if e.stderr:
            logger.error(f"stderr before timeout: {e.stderr}")
        device.updateStateOnServer('imageGenerationStatus', 'timeout')
        device.updateStateOnServer('imageGenerationError', error_msg)
        return False

    except FileNotFoundError:
        error_msg = f"Python interpreter not found: {constants.PYTHON3_PATH}"
        logger.error(error_msg)
        device.updateStateOnServer('imageGenerationStatus', 'config_error')
        device.updateStateOnServer('imageGenerationError', error_msg)
        return False

    except Exception as e:
        error_msg = f"Unexpected error: {str(e)}"
        logger.exception(f"Unexpected error generating image for device '{device.name}'")
        device.updateStateOnServer('imageGenerationStatus', 'error')
        device.updateStateOnServer('imageGenerationError', error_msg)
        return False
```

Key changes:
- Remove `check=True` to handle exit codes manually instead of raising CalledProcessError
- Add specific handling for exit codes 0, 1, 2, 3
- Set imageGenerationError state with human-readable message on all error paths
- Clear imageGenerationError to empty string on success
- Keep existing TimeoutExpired and FileNotFoundError handlers but add error state updates
  </action>
  <verify>
Run syntax check:
```bash
/Library/Frameworks/Python.framework/Versions/Current/bin/python3 -m py_compile "UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py"
```

Read image_generator.py and confirm:
- subprocess.run() uses check=False
- Exit codes 0, 1, 2, 3 each have specific handling
- All error paths update both imageGenerationStatus AND imageGenerationError
- Success path clears imageGenerationError to empty string
- Docstring documents exit code meanings
  </verify>
  <done>Parent process handles text2png.py exit codes 0/1/2/3 with specific error messages. Device states updated with status and human-readable error messages.</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. XML validation:
   ```bash
   xmllint --noout "UKTrains.indigoPlugin/Contents/Server Plugin/Devices.xml"
   ```

2. Python syntax check:
   ```bash
   /Library/Frameworks/Python.framework/Versions/Current/bin/python3 -m py_compile "UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py"
   ```

3. Code pattern verification:
   ```bash
   # Check exit code handling
   grep -n "returncode == 0" "UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py"
   grep -n "returncode == 1" "UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py"
   grep -n "returncode == 2" "UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py"
   grep -n "returncode == 3" "UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py"

   # Check error state updates
   grep -n "imageGenerationError" "UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py"
   grep -n "imageGenerationError" "UKTrains.indigoPlugin/Contents/Server Plugin/Devices.xml"

   # Verify check=False
   grep -n "check=False" "UKTrains.indigoPlugin/Contents/Server Plugin/image_generator.py"
   ```

4. PNG quality verification (from Phase 3 research):
   - PNG with optimize=True is compatible with:
     - Indigo control pages (static file serving with image/png MIME)
     - Pushover API (accepts image/png up to 5MB)
     - iOS UIImage (native PNG support)
   - Departure board PNGs are typically <100KB, well under all limits
</verification>

<success_criteria>
- [ ] Devices.xml contains imageGenerationError state with String type
- [ ] image_generator.py compiles without syntax errors
- [ ] subprocess.run() uses check=False for manual exit code handling
- [ ] Exit code 0 updates status to 'success' and clears error
- [ ] Exit code 1 updates status to 'failed' with file I/O error message
- [ ] Exit code 2 updates status to 'failed' with PIL error message
- [ ] Exit code 3 updates status to 'failed' with configuration error message
- [ ] Unknown exit codes handled with generic error message
- [ ] TimeoutExpired and FileNotFoundError also update imageGenerationError
- [ ] Requirements ERR-05, ERR-06, PNG-01, PNG-02, PNG-03, PNG-04, PNG-05 addressed
- [ ] BUG-03 verified (per-device PNG via CRS codes - already implemented in config.py)
</success_criteria>

<output>
After completion, create `.planning/phases/03-error-handling-png-quality/03-02-SUMMARY.md`
</output>
