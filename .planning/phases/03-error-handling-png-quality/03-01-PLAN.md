---
phase: 03-error-handling-png-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - UKTrains.indigoPlugin/Contents/Server Plugin/text2png.py
autonomous: true

must_haves:
  truths:
    - "text2png.py returns exit code 0 on successful PNG generation"
    - "text2png.py returns exit code 1 on file I/O errors (read/write failures)"
    - "text2png.py returns exit code 2 on PIL/Pillow errors (font loading, image creation)"
    - "text2png.py returns exit code 3 on other errors (argument parsing, configuration)"
    - "Font loading falls back to default font when TrueType file is missing"
    - "Error messages are written to stderr before exit"
  artifacts:
    - path: "UKTrains.indigoPlugin/Contents/Server Plugin/text2png.py"
      provides: "Standalone PNG generator with standardized exit codes"
      contains: "sys.exit(0)"
      contains: "sys.exit(1)"
      contains: "sys.exit(2)"
      contains: "sys.exit(3)"
      contains: "load_font_safe"
  key_links:
    - from: "text2png.py"
      to: "PIL.ImageFont"
      via: "try-except with OSError handling"
      pattern: "except OSError.*load_default"
    - from: "text2png.py"
      to: "sys.stderr"
      via: "error output before exit"
      pattern: "print.*file=sys.stderr.*sys.exit"
---

<objective>
Refactor text2png.py with standardized exit codes and font fallback

Purpose: Enable parent process to identify specific error types (file I/O, PIL, other) for meaningful logging and device state updates. Prevent crashes when font files are missing.

Output: Updated text2png.py with exit codes 0/1/2/3 and graceful font fallback
</objective>

<execution_context>
@/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-error-handling-png-quality/03-RESEARCH.md
@UKTrains.indigoPlugin/Contents/Server Plugin/text2png.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add font fallback helper and standardized exit codes</name>
  <files>UKTrains.indigoPlugin/Contents/Server Plugin/text2png.py</files>
  <action>
Refactor text2png.py to implement standardized error handling:

1. Add `load_font_safe()` helper function at top of file (after imports):
   ```python
   def load_font_safe(font_path: str, size: int, font_name: str = "font"):
       """Load TrueType font with fallback to default.

       Args:
           font_path: Path to .ttf file
           size: Font size in points
           font_name: Description for error messages

       Returns:
           ImageFont object (truetype or default)
       """
       try:
           return ImageFont.truetype(font_path, size)
       except OSError as e:
           print(f"Warning: Could not load {font_name} '{font_path}': {e}", file=sys.stderr)
           print(f"Using default font for {font_name}", file=sys.stderr)
           return ImageFont.load_default()
   ```

2. Replace all ImageFont loading (lines 100-108) with load_font_safe() calls:
   - `font = load_font_safe(fontFullPath, fontsize + 4, "regular")`
   - `titleFont = load_font_safe(fontFullPathTitle, fontsize + 12, "title")`
   - `statusFont = load_font_safe(fontFullPath, fontsize + 5, "status")`
   - `departFont = load_font_safe(fontFullPath, fontsize + 8, "depart")`
   - `delayFont = load_font_safe(fontFullPath, fontsize + 4, "delay")`
   - `callingFont = load_font_safe(fontCallingPoints, fontsize + 2, "calling")`
   - `messagesFont = load_font_safe(fontCallingPoints, fontsize, "messages")`

3. Fix the PIL import error handling (line 17-19):
   - Change exit code from 21 to 2 (PIL error category)
   - Write to stderr: `print(f"PILLOW or PIL must be installed: {e}", file=sys.stderr)`
   - Call sys.exit(2) directly (not wrapped in print)

4. Fix argument validation (lines 33-34):
   - Add proper exit with code 3 after error message
   - Write to stderr: `print("Error: Insufficient arguments", file=sys.stderr)`
   - sys.exit(3) directly

5. Update the parameter file reading (lines 59-70):
   - Wrap in try-except
   - Catch (OSError, IOError) for file read errors -> exit code 1
   - Catch (IndexError, ValueError) for parsing errors -> exit code 3
   - Write error details to stderr before exit

AVOID: Using print(sys.exit(N)) pattern - this always exits with 0. Call sys.exit() directly.
WHY: The current `print(sys.exit(22))` on line 79 actually prints None and exits with 0, masking the error.
  </action>
  <verify>
Read text2png.py and confirm:
- load_font_safe() function exists with try-except OSError handling
- All 7 font loading calls use load_font_safe()
- PIL import uses sys.exit(2) directly (not print(sys.exit()))
- Argument validation uses sys.exit(3) directly
- Parameter file reading has proper try-except with exit codes 1 and 3
  </verify>
  <done>Font fallback implemented for all 7 fonts with OSError handling and graceful degradation to default font. Exit codes 2 and 3 properly used for PIL and argument errors.</done>
</task>

<task type="auto">
  <name>Task 2: Implement file I/O and save error handling with exit codes</name>
  <files>UKTrains.indigoPlugin/Contents/Server Plugin/text2png.py</files>
  <action>
Continue refactoring text2png.py for complete error handling:

1. Fix the text file reading (currently lines 75-79):
   - Replace the buggy `print(sys.exit(22))` with proper try-except
   - Wrap entire text file reading in try block:
     ```python
     try:
         with open(trainTextFile, 'r') as routeInfo:
             stationTitles = routeInfo.readline()
             stationStatistics = routeInfo.readline()
             timeTable = ''
             for line in routeInfo:
                 timeTable = timeTable + '\n' + line.rstrip('\n')
     except (OSError, IOError) as e:
         print(f"Error reading text file '{trainTextFile}': {e}", file=sys.stderr)
         sys.exit(1)  # File I/O error
     ```

2. Wrap image creation (Image.new, ImageDraw) in try-except:
   ```python
   try:
       img = Image.new("RGBA", (width, img_height), bgcolour)
       draw = ImageDraw.Draw(img)
   except ValueError as e:
       print(f"PIL error creating image: {e}", file=sys.stderr)
       sys.exit(2)  # PIL error
   except Exception as e:
       print(f"Unexpected error creating image: {e}", file=sys.stderr)
       sys.exit(2)  # PIL error
   ```

3. Wrap PNG save with optimize=True and exit code handling (line 223):
   ```python
   try:
       img.save(imageFileName, 'png', optimize=True)
       sys.exit(0)  # Success
   except OSError as e:
       print(f"Error writing PNG file '{imageFileName}': {e}", file=sys.stderr)
       sys.exit(1)  # File I/O error
   except Exception as e:
       print(f"Unexpected error saving PNG: {e}", file=sys.stderr)
       sys.exit(3)  # Other error
   ```

4. Add outer try-except around entire main logic as catch-all:
   ```python
   try:
       # ... all existing logic ...
   except Exception as e:
       print(f"Unexpected error in image generation: {e}", file=sys.stderr)
       import traceback
       traceback.print_exc()
       sys.exit(3)  # Other error
   ```

5. Remove debug print statements (lines 42-45) that print arguments - these clutter subprocess output.

IMPORTANT: Use optimize=True parameter in img.save() for PNG optimization (cross-platform compatibility, smaller file size).
  </action>
  <verify>
Run syntax check on text2png.py:
```bash
/Library/Frameworks/Python.framework/Versions/Current/bin/python3 -m py_compile UKTrains.indigoPlugin/Contents/Server\ Plugin/text2png.py
```

Read text2png.py and confirm:
- Text file reading uses with statement and proper exception handling
- Image creation wrapped in try-except with exit code 2
- PNG save uses optimize=True and exits with code 0 on success, 1 on OSError
- Catch-all exception handler at outer level exits with code 3
- No print(sys.exit()) patterns remain
- Debug prints removed
  </verify>
  <done>Complete error handling with exit codes 0/1/2/3 for success/file-io/pil/other. PNG saved with optimize=True. All file operations have proper try-except blocks.</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Syntax validation:
   ```bash
   /Library/Frameworks/Python.framework/Versions/Current/bin/python3 -m py_compile "UKTrains.indigoPlugin/Contents/Server Plugin/text2png.py"
   ```

2. Exit code verification (dry run with missing files):
   ```bash
   /Library/Frameworks/Python.framework/Versions/Current/bin/python3 "UKTrains.indigoPlugin/Contents/Server Plugin/text2png.py" 2>&1; echo "Exit: $?"
   # Should show error message and exit code 3 (insufficient arguments)
   ```

3. Code pattern verification:
   - Grep for `sys.exit(0)` - should exist (success)
   - Grep for `sys.exit(1)` - should exist (file I/O)
   - Grep for `sys.exit(2)` - should exist (PIL)
   - Grep for `sys.exit(3)` - should exist (other)
   - Grep for `load_font_safe` - should exist
   - Grep for `print(sys.exit` - should NOT exist (bug pattern)
   - Grep for `optimize=True` - should exist
</verification>

<success_criteria>
- [ ] text2png.py compiles without syntax errors
- [ ] Exit code 0 used for successful PNG generation
- [ ] Exit code 1 used for file I/O errors (read/write failures)
- [ ] Exit code 2 used for PIL/Pillow errors (import, font, image creation)
- [ ] Exit code 3 used for other errors (arguments, configuration, unexpected)
- [ ] All 7 font loading operations use load_font_safe() with fallback
- [ ] PNG saved with optimize=True for cross-platform compatibility
- [ ] All error messages written to stderr before exit
- [ ] No print(sys.exit()) antipattern remains
- [ ] Requirements ERR-01, ERR-02, ERR-03, ERR-04, ERR-07 addressed
</success_criteria>

<output>
After completion, create `.planning/phases/03-error-handling-png-quality/03-01-SUMMARY.md`
</output>
