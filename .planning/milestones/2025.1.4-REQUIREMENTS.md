# Requirements Archive: 2025.1.4 Departure Board Image Fix

**Archived:** 2026-02-02
**Status:** âœ… SHIPPED

This is the archived requirements specification for 2025.1.4.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

# Requirements: UK-Trains Departure Board Image Fix

**Defined:** 2026-02-01
**Core Value:** Reliable, high-quality departure board images across web, mobile push, and native iOS contexts

## v1 Requirements

Requirements for this fix/modernization release. Each maps to roadmap phases.

### Subprocess Reliability

- [x] **SUB-01**: Subprocess execution has 10-second timeout to prevent unbounded hangs
- [x] **SUB-02**: TimeoutExpired exceptions are caught and logged with device name
- [x] **SUB-03**: Device state updates when subprocess times out
- [x] **SUB-04**: Subprocess stderr is captured and written to plugin logs
- [x] **SUB-05**: Subprocess uses `subprocess.run()` (not deprecated `call()`)

### Change Detection

- [x] **CHG-01**: Content hash computed from board text data and color parameters
- [x] **CHG-02**: Hash stored in device state as `image_content_hash`
- [x] **CHG-03**: PNG regeneration skipped if hash unchanged from previous update
- [x] **CHG-04**: Hash updated after successful PNG generation
- [x] **CHG-05**: Hash computation uses SHA256 algorithm

### Error Handling

- [x] **ERR-01**: text2png.py returns exit code 0 for success
- [x] **ERR-02**: text2png.py returns exit code 1 for file I/O errors
- [x] **ERR-03**: text2png.py returns exit code 2 for PIL/Pillow errors
- [x] **ERR-04**: text2png.py returns exit code 3 for other errors
- [x] **ERR-05**: Parent process checks exit codes and logs specific error type
- [x] **ERR-06**: Device state updated with error message when generation fails
- [x] **ERR-07**: Font fallback implemented when specified font missing

### PNG Quality

- [x] **PNG-01**: PNG images display correctly in Indigo control pages
- [x] **PNG-02**: PNG format compatible with Pushover notification delivery
- [x] **PNG-03**: PNG images suitable for iOS UIImage display
- [x] **PNG-04**: Color scheme from recent refactor properly applied to images
- [x] **PNG-05**: Images saved to correct local folder path

### Bug Fixes

- [x] **BUG-01**: Color definitions from constants.py correctly passed to text2png.py
- [x] **BUG-02**: PNG generation executes when Darwin API data updates
- [x] **BUG-03**: One PNG file generated per route device (not shared across devices)

## v2 Requirements

Deferred to future releases. Tracked but not in current scope.

### Performance Optimization

- **PERF-01**: Async queue pattern for image generation (only if >20 devices)
- **PERF-02**: Parallel image generation for multiple devices
- **PERF-03**: In-process PIL/Pillow (if library conflicts resolved)

### Enhanced Monitoring

- **MON-01**: Telemetry for image generation errors frequency
- **MON-02**: Metrics for change detection hit rate
- **MON-03**: Performance monitoring for subprocess spawn overhead

## Out of Scope

Explicitly excluded from this effort. Documented to prevent scope creep.

| Feature | Reason |
|---------|--------|
| Arrivals board support | Known limitation, separate feature request |
| Real-time Pushover notifications | Separate integration, only ensure PNG format compatible |
| iOS app integration code | Separate iOS project, only ensure PNG format works |
| Increasing 10-train device limit | Current limit is intentional, no user request to change |
| Changing image format (SVG, WebP) | PNG works for all three contexts, no need |
| In-process PIL migration | Research shows subprocess isolation is correct pattern |
| Async queue implementation | Only needed at scale (>20 devices), defer until necessary |

## Traceability

Which phases cover which requirements. Updated during roadmap creation.

| Requirement | Phase | Status |
|-------------|-------|--------|
| SUB-01 | Phase 1 | Complete |
| SUB-02 | Phase 1 | Complete |
| SUB-03 | Phase 1 | Complete |
| SUB-04 | Phase 1 | Complete |
| SUB-05 | Phase 1 | Complete |
| BUG-01 | Phase 1 | Complete |
| CHG-01 | Phase 2 | Complete |
| CHG-02 | Phase 2 | Complete |
| CHG-03 | Phase 2 | Complete |
| CHG-04 | Phase 2 | Complete |
| CHG-05 | Phase 2 | Complete |
| BUG-02 | Phase 2 | Complete |
| ERR-01 | Phase 3 | Complete |
| ERR-02 | Phase 3 | Complete |
| ERR-03 | Phase 3 | Complete |
| ERR-04 | Phase 3 | Complete |
| ERR-05 | Phase 3 | Complete |
| ERR-06 | Phase 3 | Complete |
| ERR-07 | Phase 3 | Complete |
| PNG-01 | Phase 3 | Complete |
| PNG-02 | Phase 3 | Complete |
| PNG-03 | Phase 3 | Complete |
| PNG-04 | Phase 3 | Complete |
| PNG-05 | Phase 3 | Complete |
| BUG-03 | Phase 3 | Complete |

**Coverage:**
- v1 requirements: 26 total
- Mapped to phases: 26/26 (100%)
- Unmapped: 0

---

## Milestone Summary

**Shipped:** 26 of 26 v1 requirements (100%)

**Adjusted:** None - all requirements implemented as originally defined

**Dropped:** None - all planned requirements delivered

---
*Archived: 2026-02-02 as part of 2025.1.4 milestone completion*
