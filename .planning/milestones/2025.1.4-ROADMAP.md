# Milestone 2025.1.4: Departure Board Image Fix

**Status:** âœ… SHIPPED 2026-02-02
**Phases:** 1-3
**Total Plans:** 4

## Overview

Fix and modernize the UK-Trains plugin's broken departure board PNG generation through three focused phases: restore subprocess reliability with timeout enforcement, add intelligent change detection to skip unnecessary regenerations, and implement comprehensive error handling with proper color scheme application. Each phase builds on the previous to deliver progressively better image generation quality and reliability.

## Phases

### Phase 1: Subprocess Reliability

**Goal:** Subprocess image generation executes safely with timeout enforcement and error reporting

**Depends on:** Nothing (first phase)

**Plans:** 1 plan

Plans:
- [x] 01-01: Add timeout, error handling, and stderr capture to subprocess execution

**Details:**

**Requirements:** SUB-01, SUB-02, SUB-03, SUB-04, SUB-05, BUG-01

**Success Criteria:**
1. Subprocess execution never hangs indefinitely (10-second timeout enforced)
2. Device state updates when subprocess times out or fails
3. Subprocess stderr appears in plugin logs for debugging
4. Color definitions from constants.py correctly passed to text2png.py

**Completed:** 2026-02-02

---

### Phase 2: Change Detection

**Goal:** Image regeneration only occurs when departure board data actually changes

**Depends on:** Phase 1

**Plans:** 1 plan

Plans:
- [x] 02-01: Add SHA-256 content hashing to detect board data changes

**Details:**

**Requirements:** CHG-01, CHG-02, CHG-03, CHG-04, CHG-05, BUG-02

**Success Criteria:**
1. Content hash computed from board text and color parameters before generation
2. PNG regeneration skipped when hash matches previous generation
3. Hash stored in device state and updated after successful generation
4. PNG generation executes when Darwin API data updates

**Completed:** 2026-02-02

---

### Phase 3: Error Handling & PNG Quality

**Goal:** Comprehensive error handling with proper exit codes and high-quality PNG output across all display contexts

**Depends on:** Phase 2

**Plans:** 2 plans

Plans:
- [x] 03-01: Refactor text2png.py with standardized exit codes and font fallback
- [x] 03-02: Implement exit code handling in parent process and add device error state

**Details:**

**Requirements:** ERR-01, ERR-02, ERR-03, ERR-04, ERR-05, ERR-06, ERR-07, PNG-01, PNG-02, PNG-03, PNG-04, PNG-05, BUG-03

**Success Criteria:**
1. text2png.py returns specific exit codes for different failure types (0=success, 1=file I/O, 2=PIL error, 3=other)
2. Device state displays meaningful error messages when image generation fails
3. Font fallback works when specified font file is missing
4. PNG images display correctly in Indigo control pages
5. PNG format compatible with Pushover notification delivery
6. PNG images suitable for iOS UIImage display
7. Color scheme properly applied to all generated images
8. One PNG file generated per route device (not shared)

**Completed:** 2026-02-02

---

## Milestone Summary

**Key Decisions:**
- SUB-01: 10-second timeout for image generation subprocess (generous buffer for I/O-bound operations)
- SUB-02: capture_output=True instead of file-based logging (unified debugging in plugin logs)
- SUB-03: Device state for image generation status (enables Indigo triggers and user visibility)
- CHG-01: Hash computed from board text and parameters file (color scheme affects visual output)
- CHG-05: SHA-256 used for collision-resistant hashing (industry standard)
- ERR-01 through ERR-04: Standardized exit codes (0/1/2/3) for error categorization
- ERR-06: PNG saved with optimize=True for smaller file size and compatibility

**Issues Resolved:**
- Subprocess hangs eliminated with timeout enforcement
- Change detection prevents unnecessary CPU/disk I/O during stable polling periods
- Font fallback prevents crashes when TrueType fonts unavailable
- User-visible error messages enable self-service troubleshooting
- Color scheme regression fixed (BUG-01)
- PNG generation executes on data updates (BUG-02)
- One PNG per device, not shared (BUG-03)

**Technical Debt Incurred:**
None - all phases delivered production-ready code with comprehensive error handling and no TODO/FIXME markers

---

_For current project status, see .planning/ROADMAP.md (created for next milestone)_
